{"version":3,"file":"sync.js","names":[],"sources":["../src/tex/packages.ts","../src/sync.ts"],"sourcesContent":["import type { TexPackage } from \"../mathjax.js\";\n\nexport const texPackages: TexPackage[] = [\n  \"action\",\n  \"ams\",\n  \"amscd\",\n  \"bbm\",\n  \"bboldx\",\n  \"bbox\",\n  \"begingroup\",\n  \"boldsymbol\",\n  \"braket\",\n  \"bussproofs\",\n  \"cancel\",\n  \"cases\",\n  \"centernot\",\n  \"color\",\n  \"colortbl\",\n  \"colorv2\",\n  \"configmacros\",\n  \"dsfont\",\n  \"empheq\",\n  \"enclose\",\n  \"extpfeil\",\n  \"gensymb\",\n  \"html\",\n  \"mathtools\",\n  \"mhchem\",\n  \"newcommand\",\n  \"noerrors\",\n  \"noundefined\",\n  \"physics\",\n  \"setoptions\",\n  \"tagformat\",\n  \"texhtml\",\n  \"textcomp\",\n  \"textmacros\",\n  \"unicode\",\n  \"units\",\n  \"upgreek\",\n  \"verb\",\n];\n","/**\n * Forked from https://github.com/tani/markdown-it-mathjax3/blob/master/index.ts\n */\nimport type { MathJaxNewcmFont as MathJaxNewcmHTMLFont } from \"@mathjax/mathjax-newcm-font/cjs/chtml.js\";\nimport type { MathJaxNewcmFont as MathJaxNewcmSVGFont } from \"@mathjax/mathjax-newcm-font/cjs/svg.js\";\nimport type { AssistiveMmlHandler as AssistiveMmlHandlerType } from \"@mathjax/src/cjs/a11y/assistive-mml.js\";\nimport type { LiteDocument } from \"@mathjax/src/cjs/adaptors/lite/Document.js\";\nimport type { LiteElement, LiteNode } from \"@mathjax/src/cjs/adaptors/lite/Element.js\";\nimport type { LiteText } from \"@mathjax/src/cjs/adaptors/lite/Text.js\";\nimport type {\n  LiteAdaptor,\n  liteAdaptor as liteAdaptorType,\n} from \"@mathjax/src/cjs/adaptors/liteAdaptor.js\";\nimport type { MathDocument } from \"@mathjax/src/cjs/core/MathDocument.js\";\nimport type { RegisterHTMLHandler as RegisterHTMLHandlerType } from \"@mathjax/src/cjs/handlers/html.js\";\nimport type { TeX as TeXType } from \"@mathjax/src/cjs/input/tex.js\";\nimport type { mathjax as mathjaxType } from \"@mathjax/src/cjs/mathjax.js\";\nimport type { CHTML as CHTMLType } from \"@mathjax/src/cjs/output/chtml.js\";\nimport type { SVG as SVGType } from \"@mathjax/src/cjs/output/svg.js\";\nimport { tex } from \"@mdit/plugin-tex\";\nimport type MarkdownIt from \"markdown-it\";\n\nimport type { MarkdownItMathjaxOptions, TeXTransformer } from \"./options.js\";\nimport { texPackages } from \"./tex/index.js\";\n\n// oxlint-disable-next-line import/no-unassigned-import\nimport \"./tex/importer.js\";\nimport { createRequire } from \"node:module\";\n\nlet isMathJaxFullInstalled = true;\nlet mathjaxLib: typeof mathjaxType;\nlet TeX: typeof TeXType;\nlet CHTML: typeof CHTMLType;\nlet SVG: typeof SVGType;\nlet liteAdaptor: typeof liteAdaptorType;\nlet RegisterHTMLHandler: typeof RegisterHTMLHandlerType;\nlet AssistiveMmlHandler: typeof AssistiveMmlHandlerType;\nlet isMathJaxNewcmFontInstalled = true;\nlet chtmlFont: typeof MathJaxNewcmHTMLFont;\nlet svgFont: typeof MathJaxNewcmSVGFont;\n\ntry {\n  ({ mathjax: mathjaxLib } = await import(\"@mathjax/src/cjs/mathjax.js\"));\n  ({ TeX } = await import(\"@mathjax/src/cjs/input/tex.js\"));\n  ({ CHTML } = await import(\"@mathjax/src/cjs/output/chtml.js\"));\n  ({ SVG } = await import(\"@mathjax/src/cjs/output/svg.js\"));\n  ({ liteAdaptor } = await import(\"@mathjax/src/cjs/adaptors/liteAdaptor.js\"));\n  ({ RegisterHTMLHandler } = await import(\"@mathjax/src/cjs/handlers/html.js\"));\n  ({ AssistiveMmlHandler } = await import(\"@mathjax/src/cjs/a11y/assistive-mml.js\"));\n  await import(\"./tex/importer.js\");\n\n  const require = createRequire(import.meta.url);\n\n  mathjaxLib.asyncLoad = (file) => {\n    require(file);\n  };\n  mathjaxLib.asyncIsSynchronous = true;\n} catch {\n  /* istanbul ignore next -- @preserve */\n  isMathJaxFullInstalled = false;\n}\n\ntry {\n  // oxlint-disable-next-line unicorn/no-await-expression-member\n  chtmlFont = (await import(\"@mathjax/mathjax-newcm-font/cjs/chtml.js\")).MathJaxNewcmFont;\n  // oxlint-disable-next-line unicorn/no-await-expression-member\n  svgFont = (await import(\"@mathjax/mathjax-newcm-font/cjs/svg.js\")).MathJaxNewcmFont;\n} catch {\n  /* istanbul ignore next -- @preserve */\n  isMathJaxNewcmFontInstalled = false;\n}\n\nexport interface DocumentOptions {\n  InputJax: TeXType<LiteElement, string, HTMLElement>;\n  OutputJax:\n    | CHTMLType<LiteElement, string, HTMLElement>\n    | SVGType<LiteElement, string, HTMLElement>;\n  enableAssistiveMml: boolean;\n}\n\nexport const getDocumentOptions = (options: MarkdownItMathjaxOptions): DocumentOptions => {\n  /* istanbul ignore if -- @preserve */\n  if (!isMathJaxFullInstalled)\n    throw new Error('[@mdit/plugin-mathjax-slim] \"@mathjax/src\" is not installed!');\n\n  const isCHTML = options.output === \"chtml\";\n  const userOptions = (isCHTML ? options.chtml : options.svg) ?? {};\n\n  /* istanbul ignore if -- @preserve */\n  if (!userOptions.fontData && !isMathJaxNewcmFontInstalled)\n    throw new Error('[@mdit/plugin-mathjax-slim] \"@mathjax/mathjax-newcm-font\" is not installed!');\n\n  const outputOptions = Object.assign(\n    {\n      fontData: isCHTML ? chtmlFont : svgFont,\n    },\n    // fontURL can be set to undefined if you want to bundle the fonts yourself\n    // both fontURL and dynamicPrefix shall be synced with fontData, so set it to undefined if fontData is customized\n    userOptions?.fontData\n      ? {}\n      : { dynamicPrefix: `@mathjax/mathjax-newcm-font/cjs/${isCHTML ? \"chtml\" : \"svg\"}/dynamic` },\n    isCHTML && !userOptions.fontData\n      ? { fontURL: \"https://cdn.jsdelivr.net/npm/@mathjax/mathjax-newcm-font/chtml/woff2\" }\n      : {},\n    userOptions,\n  );\n\n  return {\n    InputJax: new TeX<LiteElement, string, HTMLElement>({\n      packages: [\"base\", ...texPackages],\n      ...options.tex,\n    }),\n    OutputJax: new (isCHTML ? CHTML : SVG)<LiteElement, string, HTMLElement>(outputOptions),\n\n    enableAssistiveMml: options.a11y !== false,\n  };\n};\n\n/**\n * Mathjax instance\n */\nexport interface MathjaxInstance extends Required<\n  Pick<MarkdownItMathjaxOptions, \"allowInlineWithSpace\" | \"delimiters\" | \"mathFence\">\n> {\n  /**\n   * Mathjax adaptor\n   */\n  adaptor: LiteAdaptor;\n\n  /**\n   * Mathjax document options\n   */\n  documentOptions: DocumentOptions;\n\n  /**\n   * Clear style cache\n   */\n  clearStyle: () => void;\n\n  /**\n   * Output style for rendered content and clears it\n   *\n   * @returns style\n   */\n  outputStyle: () => string;\n\n  /**\n   * Reset tex (including labels)\n   */\n  reset: () => void;\n\n  /**\n   * Output content transformer\n   */\n  transformer: TeXTransformer | null;\n}\n\nexport const createMathjaxInstance = (\n  options: MarkdownItMathjaxOptions = {},\n): MathjaxInstance | null => {\n  const documentOptions = getDocumentOptions(options);\n\n  const { OutputJax, InputJax } = documentOptions;\n\n  const adaptor = liteAdaptor();\n  // oxlint-disable-next-line new-cap\n  const handler = RegisterHTMLHandler(adaptor);\n\n  // oxlint-disable-next-line new-cap\n  if (options.a11y !== false) AssistiveMmlHandler<LiteNode, LiteText, LiteDocument>(handler);\n\n  const clearStyle = (): void => {\n    // if there is no adaptor, output jax is not initialized yet, so nothing to clear\n    if (!OutputJax.adaptor) return;\n\n    OutputJax.reset();\n  };\n\n  const reset = (): void => {\n    InputJax.reset();\n  };\n\n  const outputStyle = (): string => {\n    OutputJax.font.loadDynamicFilesSync();\n\n    const style = adaptor.cssText(\n      OutputJax.styleSheet(\n        mathjaxLib.document(\"\", documentOptions) as MathDocument<LiteElement, string, HTMLElement>,\n      ),\n    );\n\n    clearStyle();\n\n    return style;\n  };\n\n  return {\n    adaptor,\n    documentOptions,\n    allowInlineWithSpace: options.allowInlineWithSpace ?? false,\n    delimiters: options.delimiters ?? \"dollars\",\n    mathFence: options.mathFence ?? false,\n    clearStyle,\n    reset,\n    outputStyle,\n    transformer: options.transformer ?? null,\n  };\n};\n\nexport const mathjax = (\n  md: MarkdownIt,\n  {\n    allowInlineWithSpace,\n    adaptor,\n    delimiters,\n    documentOptions,\n    mathFence,\n    transformer,\n  }: MathjaxInstance,\n): void => {\n  md.use(tex, {\n    allowInlineWithSpace,\n    delimiters,\n    mathFence,\n    render: (content, displayMode) => {\n      const mathDocument = mathjaxLib.document(content, documentOptions).convert(content, {\n        display: displayMode,\n      }) as LiteElement;\n\n      const result = adaptor.outerHTML(mathDocument);\n\n      return transformer?.(result, displayMode) ?? result;\n    },\n  });\n};\n"],"mappings":"mFAEA,MAAa,EAA4B,iUAuCxC,CCZD,IAAI,EAAyB,GACzB,EACA,EACA,EACA,EACA,EACA,EACA,EACA,EAA8B,GAC9B,EACA,EAEJ,GAAI,EACD,CAAE,QAAS,GAAe,MAAM,OAAO,gCACvC,QAAU,MAAM,OAAO,iCACvB,UAAY,MAAM,OAAO,oCACzB,QAAU,MAAM,OAAO,kCACvB,gBAAkB,MAAM,OAAO,4CAC/B,wBAA0B,MAAM,OAAO,qCACvC,wBAA0B,MAAM,OAAO,0CACxC,MAAM,OAAO,0BAEb,IAAM,EAAU,EAAc,OAAO,KAAK,IAAI,CAE9C,EAAW,UAAa,GAAS,CAC/B,EAAQ,EAAK,EAEf,EAAW,mBAAqB,QAC1B,CAEN,EAAyB,GAG3B,GAAI,CAEF,GAAa,MAAM,OAAO,6CAA6C,iBAEvE,GAAW,MAAM,OAAO,2CAA2C,sBAC7D,CAEN,EAA8B,GAWhC,MAAa,EAAsB,GAAuD,CAExF,GAAI,CAAC,EACH,MAAU,MAAM,+DAA+D,CAEjF,IAAM,EAAU,EAAQ,SAAW,QAC7B,GAAe,EAAU,EAAQ,MAAQ,EAAQ,MAAQ,EAAE,CAGjE,GAAI,CAAC,EAAY,UAAY,CAAC,EAC5B,MAAU,MAAM,8EAA8E,CAEhG,IAAM,EAAgB,OAAO,OAC3B,CACE,SAAU,EAAU,EAAY,EACjC,CAGD,GAAa,SACT,EAAE,CACF,CAAE,cAAe,mCAAmC,EAAU,QAAU,MAAM,UAAW,CAC7F,GAAW,CAAC,EAAY,SACpB,CAAE,QAAS,uEAAwE,CACnF,EAAE,CACN,EACD,CAED,MAAO,CACL,SAAU,IAAI,EAAsC,CAClD,SAAU,CAAC,OAAQ,GAAG,EAAY,CAClC,GAAG,EAAQ,IACZ,CAAC,CACF,UAAW,IAAK,EAAU,EAAQ,GAAuC,EAAc,CAEvF,mBAAoB,EAAQ,OAAS,GACtC,EA0CU,GACX,EAAoC,EAAE,GACX,CAC3B,IAAM,EAAkB,EAAmB,EAAQ,CAE7C,CAAE,YAAW,YAAa,EAE1B,EAAU,GAAa,CAEvB,EAAU,EAAoB,EAAQ,CAGxC,EAAQ,OAAS,IAAO,EAAsD,EAAQ,CAE1F,IAAM,MAAyB,CAExB,EAAU,SAEf,EAAU,OAAO,EAqBnB,MAAO,CACL,UACA,kBACA,qBAAsB,EAAQ,sBAAwB,GACtD,WAAY,EAAQ,YAAc,UAClC,UAAW,EAAQ,WAAa,GAChC,aACA,UAzBwB,CACxB,EAAS,OAAO,EAyBhB,gBAtBgC,CAChC,EAAU,KAAK,sBAAsB,CAErC,IAAM,EAAQ,EAAQ,QACpB,EAAU,WACR,EAAW,SAAS,GAAI,EAAgB,CACzC,CACF,CAID,OAFA,GAAY,CAEL,GAYP,YAAa,EAAQ,aAAe,KACrC,EAGU,GACX,EACA,CACE,uBACA,UACA,aACA,kBACA,YACA,iBAEO,CACT,EAAG,IAAI,EAAK,CACV,uBACA,aACA,YACA,QAAS,EAAS,IAAgB,CAChC,IAAM,EAAe,EAAW,SAAS,EAAS,EAAgB,CAAC,QAAQ,EAAS,CAClF,QAAS,EACV,CAAC,CAEI,EAAS,EAAQ,UAAU,EAAa,CAE9C,OAAO,IAAc,EAAQ,EAAY,EAAI,GAEhD,CAAC"}